

<!DOCTYPE html>
<meta charset="utf-8" />
<title>WebSocket Test</title>

<script language="javascript" type="text/javascript">

var url = "ws://${window.location.hostname}/ws"; //nutno upravit, zkusit ${window.location.hostname}
var parametrP;
var parametrI;
var parametrD;
var tlacitko;


// Call the init function as soon as the page loads
window.addEventListener("load", init, false);

function init() { //volano kdyz se stranka nacte
/*
TODO:
zbavit se zbytečných funkcí
spojit button s odesíláním dat
spojit načtení stránky s příjmem dat z ESP (vymyslet protokol)
změnit defines na proměnné
použít eeprom ? nebo config.txt v spiffs
vyzkoušet na ESP


1 odeslání update do esp
2 zapsání hodnot do polí
3 po stisku tlačítka odešli obsah polí do esp
4 aktualizuj současnou hodnotu z esp

*/
    parametrP = document.getElementById("in1");
    parametrI = document.getElementById("in2");
    parametrD = document.getElementById("in3");
    tlacitko = document.getElementById("submit")
    
    
    wsConnect(url);
}

function wsConnect(url) {
    
    websocket = new WebSocket(url);
    
    // Assign callbacks
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
}


function onOpen(evt) { //zde načíst PID hodnoty

    console.log("Connected");
    
    tlacitko.disabled = false;
    
    odesliPID("update");    //pozadani ESP o aktualni PID hodnoty         
}

function onClose(evt) {

    // Log disconnection state
    console.log("Disconnected");
    
    // Disable button
    tlacitko.disabled = true;
    
    // Try to reconnect after a few seconds
    setTimeout(function() { wsConnect(url) }, 2000);
}

function onMessage(evt) {

    console.log("Received: " + evt.data);
    
    let data = JSON.parse(evt.data); //parsování dat z jsonu z esp

    for (var i = 0; i < 3; i++){
       // document.getElementById(key).innerHTML = myObj[key];
        document.getElementById("in"+ (i+1).toString()).value = data.status;
    }
}


function onError(evt) {
    console.log("ERROR: " + evt.data);
}

function odesliPID(x){ //stupni parametr je string, v pripade prikazu na ziskani dat musi byt volana fce: odesliPID( "update")
    websocket.send(JSON.strigify({"akce" : x, //co udělá když string převedu na string ?
                                  "konstantaP" : parametrP.value.toString(), 
                                  "konstantaI" : parametrI.value.toString(),
                                  "konstantaD" : parametrD.value.toString()
                                })
    )
}

//slouzi k odeslani novych hodnot do esp
function aktualizuj() {
    //odesliESP("tumasData"); //zde json
    odesliPID("0"); //jiny parametr nez update znamena ze se zapisou PID udaje ze stranky do esp
 
}


</script>

<h2>PID parametry</h2>

<table>
  
    <form>
        <label>P: </label>
        <input type="number" id="in1" value="1" step="0.01"><br> 
        <label>I: </label>
        <input type="number" id="in2" value="1" step="0.01"><br>
        <label>D: </label>
        <input type="number" id="in3" value="1" step="0.01"><br><br>
        <input type="submit" id="submit" value="Odeslat" onclick=aktualizuj()>

    
    
    </form>
</table>
